<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Collect System Info</title>
</head>
<body>
  <h1>Collecting client system info...</h1>
  <pre id="output"></pre>

<script>
async function getWebGLInfo() {
  try {
    const canvas = document.createElement("canvas");
    const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
    if (!gl) return null;
    const debugInfo = gl.getExtension("WEBGL_debug_renderer_info");
    return {
      renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : null,
      vendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : null
    };
  } catch (e) { return null; }
}

async function getBattery() {
  try {
    if ("getBattery" in navigator) {
      const b = await navigator.getBattery();
      return {charging: b.charging, level: b.level, chargingTime: b.chargingTime, dischargingTime: b.dischargingTime};
    }
  } catch(e){}
  return null;
}

async function getMediaDevices() {
  const devicesInfo = { audio: [], video: [], speaker: [] };

  async function fetchDevices() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    devices.forEach(d => {
      if (d.kind === "audioinput" && d.label) devicesInfo.audio.push(d.label);
      if (d.kind === "videoinput" && d.label) devicesInfo.video.push(d.label);
      if (d.kind === "audiooutput" && d.label) devicesInfo.speaker.push(d.label);
    });
  }

  // Try mic
  try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch {}
  await fetchDevices();

  // Try camera
  try { await navigator.mediaDevices.getUserMedia({ video: true }); } catch {}
  await fetchDevices();

  return devicesInfo;
}

function detectOS() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;

  if (/windows phone/i.test(ua)) return "Windows Phone";
  if (/win/i.test(ua)) return "Windows";
  if (/android/i.test(ua)) return "Android";
  if (/iPad|iPhone|iPod/.test(ua)) return "iOS";
  if (/Macintosh|MacIntel|MacPPC|Mac68K/.test(ua)) return "macOS";
  if (/Linux/.test(ua)) return "Linux";

  return "Unknown";
}

function detectBrowser() {
  const ua = navigator.userAgent;

  let tem;
  let M = ua.match(/(opera|chrome|edg|firefox|safari|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
  
  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return { name: "IE", version: tem[1] || "" };
  }
  if (M[1] === "Chrome") {
    tem = ua.match(/\b(OPR|Edg)\/(\d+)/);
    if (tem != null) {
      return { name: tem[1].replace("OPR", "Opera").replace("Edg", "Edge"), version: tem[2] };
    }
  }
  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, "-?"];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
  return { name: M[0], version: M[1] };
}

async function gather() {
  const webgl = await getWebGLInfo();
  const battery = await getBattery();
  const mediaDevices = await getMediaDevices();

  const data = {
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    os: detectOS(),
    browser: detectBrowser(),
    hardware: {
      logicalCores: navigator.hardwareConcurrency || null,
      deviceMemory: navigator.deviceMemory || null,
      description: `${navigator.hardwareConcurrency || "?"} logical cores`
    },
    languages: navigator.languages || [navigator.language],
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || null,
    screen: {
      width: screen.width, height: screen.height,
      availWidth: screen.availWidth, availHeight: screen.availHeight,
      colorDepth: screen.colorDepth, pixelDepth: screen.pixelDepth
    },
    viewport: {innerWidth: innerWidth, innerHeight: innerHeight},
    connection: navigator.connection ? {
      effectiveType: navigator.connection.effectiveType,
      downlink: navigator.connection.downlink,
      rtt: navigator.connection.rtt,
      saveData: navigator.connection.saveData
    } : null,
    webgl,
    battery,
    mediaDevices
  };

  return data;
}

async function sendToServer(payload) {
  try {
    const res = await fetch("/api/system-info", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  } catch (e) {
    console.warn("‚ùå Failed to send system info:", e);
  }
}

(async function () {
  const data = await gather();
  document.getElementById("output").textContent = JSON.stringify(data, null, 2);
  const response = await sendToServer(data);
  console.log("Server response:", response);
})();
</script>
</body>
</html>
